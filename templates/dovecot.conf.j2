# Dovecot configuration file
# Auto-generated by MailHarbor. Do not edit manually.

protocols = imap
listen = *
mail_location = maildir:{{ mail_location }}
first_valid_uid = 5000
first_valid_gid = 5000
mail_uid = 5000
mail_gid = 5000
log_path = /data/logs/dovecot.log
info_log_path = /data/logs/dovecot.log
debug_log_path = /data/logs/dovecot.log
{%- if ssl_enabled %}
ssl = yes
ssl_cert = <{{ ssl_cert }}
ssl_key = <{{ ssl_key }}
ssl_min_protocol = TLSv1.2
{%- else %}
ssl = no
disable_plaintext_auth = no
{%- endif %}

auth_mechanisms = plain login

passdb {
  driver = passwd-file
  args = /etc/dovecot/users
}

userdb {
  driver = passwd-file
  args = /etc/dovecot/users
}

service imap-login {
  inet_listener imap {
    port = {{ imap_port }}
    ssl = no
  }
  {%- if ssl_enabled %}
  inet_listener imaps {
    port = {{ imaps_port }}
    ssl = yes
  }
  {%- endif %}
  process_limit = {{ performance.get('process_limit', 100) }}
  process_min_avail = 2
  service_count = 1
  vsz_limit = 64M
}

service imap {
  process_limit = {{ performance.get('process_limit', 100) * 2 }}
  vsz_limit = 256M
}

# Performance optimizations
default_process_limit = {{ performance.get('process_limit', 100) }}
default_client_limit = 1000

# Filesystem optimizations
mail_fsync = {{ performance.get('mail_fsync', 'optimized') }}
mail_nfs_storage = no
mail_nfs_index = no
mmap_disable = {{ 'yes' if performance.get('mmap_disable', False) else 'no' }}

# Prefetch optimizations
mail_prefetch_count = {{ performance.get('mail_prefetch_count', 20) }}

# Cache optimizations
mail_cache_fields = flags
mail_always_cache_fields = date.save date.sent size.virtual

# Index optimizations
mail_index_rewrite_min_log_bytes = 128k
mail_index_rewrite_max_log_bytes = 512k

# Protocol configuration
protocol imap {
  mail_max_userip_connections = {{ performance.get('mail_max_userip_connections', 10) }}
  {%- if fts.get('enabled', True) %}
  mail_plugins = $mail_plugins fts fts_{{ fts.get('plugin', 'xapian') }}
  {%- endif %}
}

# FTS full-text search plugin
{%- if fts.get('enabled', True) %}
plugin {
  fts = {{ fts.get('plugin', 'xapian') }}
  
  {%- if fts.get('plugin', 'xapian') == 'xapian' %}
  # Xapian configuration
  fts_xapian = partial=3 full=20 verbose=0
  fts_autoindex = yes
  fts_autoindex_exclude = \Trash
  fts_enforced = no
  fts_index_timeout = 60s
  fts_languages = zh_CN en
  fts_tokenizers = generic email-address
  {%- endif %}
}
{%- endif %}

# Local Delivery Agent (LDA)
protocol lda {
  postmaster_address = postmaster@localhost
  mail_plugins = $mail_plugins
}
